module.exports = function (eleventyConfig) {
  // ✅ Add date filter for Nunjucks
  eleventyConfig.addNunjucksFilter("date", function (value, format = "%Y") {
    const date = value === "now" ? new Date() : new Date(value);
    return date.getFullYear();
  });

  // Copy static assets and admin folder
  eleventyConfig.addPassthroughCopy("admin");
  eleventyConfig.addPassthroughCopy("assets");
  eleventyConfig.addPassthroughCopy("static");
  eleventyConfig.addPassthroughCopy("styles.css");

  // Automatic permalink + default layout for product collections
  eleventyConfig.addGlobalData("eleventyComputed", {
    permalink: (data) => {
      const path = data.page.filePathStem || "";

      if (path.startsWith("bracelets/"))
        return `/bracelets/${data.page.fileSlug}/index.html`;
      if (path.startsWith("rings/"))
        return `/rings/${data.page.fileSlug}/index.html`;
      if (path.startsWith("charms/"))
        return `/charms/${data.page.fileSlug}/index.html`;
      if (path.startsWith("bronze/"))
        return `/bronze/${data.page.fileSlug}/index.html`;

      return data.permalink;
    },

    layout: (data) => {
      const path = data.page.filePathStem || "";

      const isProductFamily =
        path.startsWith("bracelets/") ||
        path.startsWith("rings/") ||
        path.startsWith("charms/") ||
        path.startsWith("bronze/");

      const isCollectionIndex = !path.includes("/");

      // ✅ Only collection landing pages use category layout
      if (isProductFamily && isCollectionIndex) {
        return "category.njk";
      }

      // Otherwise, respect existing layout
      return data.layout;
    },
  });

  return {
    dir: {
      input: ".",
      includes: "_includes",
      output: "_site",
    },
  };
};
