{% extends "layouts/base.njk" %}

{% block content %}
<section class="product-page">
  <div class="container">

    {# ===============================
       NORMALIZE DATA SOURCES
       Some pages expose frontmatter at page.data.*
       Others expose it at page.data.data.*
       =============================== #}

    {% set images = (page.data.images and page.data.images.length) ? page.data.images : page.data.data.images %}
    {% set rawGallery = (page.data.gallery and page.data.gallery.length) ? page.data.gallery : page.data.data.gallery %}

    {# Featured image is always the first "images" entry (if present) #}
    {% set featuredSrc = (images and images.length) ? images[0] : null %}

    {# If gallery is missing but images has more than 1 image,
       use images[1..] as gallery fallback. #}
    {% if (not rawGallery or not rawGallery.length) and images and images.length > 1 %}
      {% set rawGallery = images | slice(1) %}
    {% endif %}

    {# ===============================
       FEATURED PRODUCT IMAGE
       =============================== #}
    {% if featuredSrc %}
      <div class="product-featured-image">
        <img
          src="{{ featuredSrc }}"
          alt="{{ title }}"
          loading="eager"
        >
      </div>
    {% endif %}

    {# ===============================
       PRODUCT GALLERY (DEDUPED)
       - removes duplicates
       - removes featured image if it appears again in gallery
       =============================== #}

    {% set gallery = [] %}

    {% if rawGallery and rawGallery.length %}
      {% for img in rawGallery %}
        {% if img and img != featuredSrc and (img not in gallery) %}
          {% set gallery = gallery.concat([img]) %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if gallery and gallery.length %}
      <section class="product-gallery-section">
        <div class="product-gallery-grid">
          {% for image in gallery %}
            <div class="product-gallery-item">
              <img
                src="{{ image }}"
                alt="{{ title }} gallery image {{ loop.index }}"
                loading="lazy"
              >
            </div>
          {% endfor %}
        </div>
      </section>
    {% endif %}

    {# ===============================
       PRODUCT CONTENT
       =============================== #}
    <div class="prose max-w-none product-content">
      {{ content | safe }}
    </div>

  </div>
</section>
{% endblock %}
